<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <title>文件/图片提交系统（优化版 — 按需加载文件）</title>

    <!-- 依赖库（保持已用的 CDN） -->
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        /* ========== 内嵌 CSS ========== */
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:PingFang SC,Helvetica,Arial,sans-serif;background:#f8fafc;color:#111827;min-height:100vh;}
        .container{max-width:960px;margin:24px auto;padding:0 16px;}
        .card{background:#fff;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 6px 20px rgba(8,15,25,0.04)}
        .status-badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:600;font-size:13px}
        .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);cursor:pointer}
        .btn-primary{background:#165DFF;color:white;border:none}
        .btn-danger{background:#EF4444;color:white;border:none}
        .text-success{color:#10B981}
        .text-warning{color:#F59E0B}
        .grid-cols-12{display:grid;grid-template-columns:repeat(12,1fr)}
        .border-b{border-bottom:1px solid #f1f5f9}
        .truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        /* spinner */
        .spinner{border:4px solid rgba(0,0,0,0.06);border-left-color:#165DFF;border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        /* modal */
        .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:50}
        .modal{background:white;border-radius:10px;padding:16px;width:92%;max-width:820px;max-height:80vh;overflow:auto}
        /* upload-area */
        #upload-area{min-height:160px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:2px dashed #e6edf8;border-radius:10px;padding:12px;cursor:pointer;background:#ffffff}
        /* responsive */
        @media(min-width:768px){ .two-cols{display:flex;gap:12px} .two-cols > *{flex:1} }
    </style>

</head>
<body>
    <div class="container">
        <!-- Role selection -->
        <div id="role-selection" class="card">
            <h1 style="font-size:20px;font-weight:700;text-align:center;margin-bottom:12px">文件/图片提交系统（优化版）</h1>
            <div class="two-cols">
                <div class="card" onclick="enterHouseOwnerMode()" style="cursor:pointer;text-align:center">
                    <i class="fa fa-user-circle-o" style="font-size:36px;color:#165DFF"></i>
                    <h3 style="font-weight:700;margin-top:8px">房主模式</h3>
                    <p style="color:#6b7280">管理名单 / 设置上传数量 / 查看并导出单人文件</p>
                </div>
                <div class="card" onclick="enterVisitorMode()" style="cursor:pointer;text-align:center">
                    <i class="fa fa-upload" style="font-size:36px;color:#165DFF"></i>
                    <h3 style="font-weight:700;margin-top:8px">访客模式</h3>
                    <p style="color:#6b7280">提交或修改文件（按房主设置的最大数量）</p>
                </div>
            </div>
        </div>

        <!-- House owner login -->
        <div id="house-owner-login" class="card" style="display:none">
            <h2 style="font-weight:700;margin-bottom:8px">房主登录</h2>
            <input id="owner-password" type="password" placeholder="管理密码" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6edf8" />
            <p id="password-error" style="color:#EF4444;margin-top:8px;display:none">密码错误</p>
            <div style="display:flex;gap:8px;margin-top:12px">
                <button class="btn btn-primary" style="flex:1" onclick="verifyHouseOwnerPassword()">登录</button>
                <button class="btn" onclick="backToRoleSelection()">取消</button>
            </div>
        </div>

        <!-- House owner dashboard -->
        <div id="house-owner-dashboard" class="card" style="display:none">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <h2 style="font-weight:700">房主管理中心</h2>
                <div style="display:flex;gap:8px">
                    <button class="btn" onclick="backToRoleSelection()">返回</button>
                </div>
            </div>

            <div style="display:flex;flex-direction:column;gap:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
                    <div>
                        <div>系统状态</div>
                        <div id="system-status-badge" class="status-badge" style="margin-top:6px">未开始</div>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center">
                        <button id="btn-start-system" class="btn btn-primary" style="display:none" onclick="startSystem()">开始</button>
                        <button id="btn-pause-system" class="btn" style="display:none" onclick="pauseSystem()">暂停</button>
                        <button id="btn-resume-system" class="btn" style="display:none" onclick="resumeSystem()">恢复</button>
                        <button id="btn-end-system" class="btn btn-danger" style="display:none" onclick="endSystem()">结束</button>
                        <button class="btn" onclick="resetSystem()">重置</button>
                    </div>
                </div>

                <!-- 上传数量 -->
                <div style="padding:12px;border-radius:8px;background:#fbfcff;border:1px solid #eef2ff;display:flex;align-items:center;gap:12px">
                    <div style="flex:1">
                        <div style="font-weight:700">每人最多允许上传几份文件</div>
                        <div style="color:#6b7280;font-size:13px">设定后会应用到现有用户（不会修改数据库表结构）</div>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center">
                        <input id="max-upload-count" type="number" min="1" value="1" style="width:80px;padding:8px;border-radius:8px;border:1px solid #e6edf8" />
                        <button class="btn btn-primary" onclick="updateUploadLimit()">保存</button>
                    </div>
                </div>

                <!-- stats -->
                <div style="display:flex;gap:12px">
                    <div style="flex:1;padding:12px;border-radius:8px;background:#fff;border:1px solid #e6edf8">
                        <div style="color:#6b7280">总人数</div>
                        <div id="total-count" style="font-weight:700;font-size:18px">0</div>
                    </div>
                    <div style="flex:1;padding:12px;border-radius:8px;background:#fff;border:1px solid #e6edf8">
                        <div style="color:#6b7280">已提交</div>
                        <div id="submitted-count" style="font-weight:700;font-size:18px;color:#10B981">0</div>
                    </div>
                    <div style="flex:1;padding:12px;border-radius:8px;background:#fff;border:1px solid #e6edf8">
                        <div style="color:#6b7280">未提交</div>
                        <div id="unsubmitted-count" style="font-weight:700;font-size:18px;color:#F59E0B">0</div>
                    </div>
                </div>

                <div style="display:flex;justify-content:flex-end">
                    <button class="btn btn-primary" onclick="exportAllSubmittedFiles()">导出全部文件</button>
                </div>

                <!-- 名单管理 -->
                <div>
                    <div style="display:flex;gap:8px;margin-bottom:8px">
                        <input id="add-name" placeholder="输入姓名" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6edf8" />
                        <button class="btn btn-primary" onclick="addSubmitter()">添加</button>
                        <label class="btn" style="padding:8px 12px;cursor:pointer">
                            导入名单
                            <input id="import-list" type="file" accept=".txt,.csv,.xlsx,.xls" style="display:none" onchange="importSubmitterList()" />
                        </label>
                    </div>

                    <div style="border:1px solid #eef2ff;border-radius:8px;overflow:hidden">
                        <div class="grid-cols-12" style="background:#f8fafc;padding:8px;font-weight:600">
                            <div style="grid-column:span 6">姓名</div>
                            <div style="grid-column:span 3">状态</div>
                            <div style="grid-column:span 3">操作</div>
                        </div>

                        <div id="submitter-list-container" style="max-height:260px;overflow:auto"></div>
                    </div>
                </div>

                <!-- 提交记录 -->
                <div>
                    <div style="font-weight:700;margin-bottom:8px">提交记录</div>
                    <div style="border:1px solid #eef2ff;border-radius:8px;overflow:hidden">
                        <div class="grid-cols-12" style="background:#f8fafc;padding:8px;font-weight:600">
                            <div style="grid-column:span 4">姓名</div>
                            <div style="grid-column:span 5">文件数量</div>
                            <div style="grid-column:span 3">提交时间</div>
                        </div>

                        <div id="submission-records-container" style="max-height:300px;overflow:auto"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Visitor verify -->
        <div id="visitor-verify" class="card" style="display:none">
            <h2 style="font-weight:700;margin-bottom:8px">访客验证</h2>
            <input id="visitor-name" placeholder="请输入姓名" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6edf8" />
            <p id="name-error" style="color:#EF4444;margin-top:8px;display:none">姓名不在名单中</p>
            <div style="display:flex;gap:8px;margin-top:12px">
                <button class="btn btn-primary" style="flex:1" onclick="verifyVisitorName()">进入</button>
                <button class="btn" onclick="backToRoleSelection()">返回</button>
            </div>
        </div>

        <!-- Visitor submit -->
        <div id="visitor-submit" class="card" style="display:none">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <h2 style="font-weight:700">提交文件</h2>
                <div id="visitor-name-display" style="font-weight:700;color:#165DFF">未识别</div>
            </div>

            <div id="upload-area" onclick="document.getElementById('file-upload').click()">
                <i class="fa fa-cloud-upload" style="font-size:36px;color:#94a3b8"></i>
                <p style="color:#6b7280;margin-top:8px">拖拽或点击选择文件（支持多选，受房主限制）</p>
                <input id="file-upload" type="file" multiple style="display:none" accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" onchange="handleFileSelect()" />
            </div>

            <div id="file-preview" style="display:none;margin-top:12px">
                <h3 style="font-weight:700;margin-bottom:6px">已选择文件</h3>
                <div id="preview-list" style="display:flex;flex-direction:column;gap:8px"></div>
            </div>

            <div style="display:flex;gap:8px;margin-top:12px">
                <button id="submit-file-btn" class="btn btn-primary" style="flex:1" disabled onclick="submitFile()">提交文件</button>
                <button class="btn" onclick="backToRoleSelection()">返回</button>
            </div>
        </div>

    </div>

    <!-- 单人预览弹窗（按需拉取 files） -->
    <div id="file-viewer-modal" class="modal-backdrop" style="display:none">
        <div class="modal">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <h3 style="font-weight:700">查看提交内容</h3>
                <div id="file-viewer-progress" style="display:flex;align-items:center;gap:8px"></div>
            </div>
            <div id="file-viewer-content" style="display:flex;flex-direction:column;gap:8px"></div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
                <button id="export-single-btn" class="btn btn-primary">导出此人全部文件</button>
                <button class="btn" onclick="closeFileViewer()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 我把逻辑放到独立 js 文件，下面引入 -->
    <script src="file-submit2.js"></script>
</body>
</html>
