<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>抽签器 — 导入名字 & 随机抽取</title>

  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min.js"></script>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--glass: rgba(255,255,255,0.04)}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:#e6eef6;background:linear-gradient(180deg,#071021 0%, #081322 100%)}
    .container{max-width:980px;margin:32px auto;padding:24px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    h1{margin:0 0 12px;font-size:20px;color:var(--accent)}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    .card{background:var(--card);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    textarea{width:100%;height:230px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;resize:vertical}
    input[type=text], input[type=number], select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;background:var(--accent);color:#042022;text-decoration:none;border:none;cursor:pointer;font-weight:600}
    .mutebtn{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .winners-list{margin-top:12px}
    .winner-pill{display:inline-block;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg, rgba(6,182,212,0.12), rgba(6,182,212,0.06));margin:6px 6px 0 0;border:1px solid rgba(6,182,212,0.12)}
    .animated-slot{height:56px;display:flex;align-items:center;justify-content:center;margin-bottom:6px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:18px}
    footer{margin-top:16px;color:var(--muted);font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    .file-row{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div class="container">
    <h1>抽签器 — 导入名字并随机抽取</h1>
    <p class="small">支持手动粘贴、CSV 导入；可选择抽取人数、导出结果、去重与复选项。页面为单文件运行，直接保存为 .html 即可本地打开。</p >

    <div class="grid">
      <div class="card">
        <label>1) 导入名字（每行一个姓名，或逗号分隔）</label>
        <textarea id="namesInput" placeholder="例如：张三\n李四\n王五 或 张三,李四,王五"></textarea>

        <div style="margin-top:10px" class="file-row">
          <input id="csvFile" type="file" accept=".csv" />
          <button class="btn" id="importCsvBtn">从 CSV 导入</button>
          <button class="mutebtn" id="clearNamesBtn">清空</button>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)" />

        <label>2) 抽取设置</label>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <div style="flex:1">
            <label class="small">抽取人数</label>
            <input id="count" type="number" min="1" value="1" />
          </div>
          <div style="width:140px">
            <label class="small">是否去重</label>
            <select id="uniqueSelect"><option value="true">是（默认）</option><option value="false">否（允许重复）</option></select>
          </div>
        </div>

        <label class="small">额外选项</label>
        <div class="controls" style="margin-bottom:8px">
          <label class="small" style="display:flex;align-items:center;gap:8px"><input id="excludeBlank" type="checkbox" checked /> 排除空行</label>
          <label class="small" style="display:flex;align-items:center;gap:8px"><input id="shuffleBefore" type="checkbox" checked /> 抽前先打乱名单</label>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="drawBtn">开始抽签</button>
          <button class="mutebtn" id="previewBtn">预览名单</button>
          <button class="mutebtn" id="exportAllBtn">导出名单 (CSV)</button>
        </div>
      </div>

      <div class="card">
        <label>3) 显示与结果</label>
        <div id="slots"></div>
        <div class="winners-list" id="winners"></div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" id="copyBtn">复制结果</button>
          <button class="mutebtn" id="exportWinnersBtn">导出中奖名单 (CSV)</button>
          <button class="mutebtn" id="resetBtn">重置抽奖</button>
        </div>

        <div style="margin-top:12px">
          <label class="small">日志</label>
          <pre id="log" style="max-height:140px;overflow:auto;padding:8px;background:rgba(0,0,0,0.15);border-radius:8px;color:var(--muted)"></pre>
        </div>
      </div>
    </div>

    <footer>提示：若名单很长，建议使用 CSV 导入（每行一个名字或第一列为名字）。需要在页面做其他定制（比如分组抽签或加权抽签）可以告诉我具体要求。</footer>
  </div>

<script>
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
<script>
/* ----------------------------
   0. 初始化 LeanCloud
----------------------------- */
AV.init({
  appId: "awjrq2pnF6yDBX2QT7Sq1dHQ-gzGzoHsz",   // ← 换成你的
  appKey: "WY6uq9q4hPthkwKX5JIHrlYk",           // ← 换成你的
  serverURL: "https://awjrq2pn.lc-cn-n1-shared.com" // ← LeanCloud控制台可查
});

/* ----------------------------
   1. 全局变量
----------------------------- */
let isOwner = false;   // 房主模式（你输入口令后变 true）
const ROOM_ID = "global-room"; // 全局房间 ID，全员共享名单
const NameList = new AV.Object.extend("NameList");

/* ----------------------------
   2. UI 元素
----------------------------- */
const namesInput = document.getElementById("namesInput");
const drawBtn = document.getElementById("drawBtn");
const clearNamesBtn = document.getElementById("clearNamesBtn");
const logBox = document.getElementById("log");
const slots = document.getElementById("slots");
const winnersDiv = document.getElementById("winners");

/* 将清空按钮禁用（普通用户不能清空名单） */
clearNamesBtn.disabled = true;

/* ----------------------------
   3. 房主口令验证
----------------------------- */
(async function askOwnerPassword(){
  const pw = prompt("请输入口令（房主可抽签+删除）：\n\n普通用户可直接点取消加入名单");
  if(pw === "666888"){       // ← 你可以改成你自己的口令
      isOwner = true;
      clearNamesBtn.disabled = false;
      drawBtn.disabled = false;
      log("已进入房主模式");
  } else {
      isOwner = false;
      drawBtn.disabled = true;
      log("访客模式：你可以添加名字，但不能清空或抽签");
  }
})();

/* ----------------------------
   4. 日志函数
----------------------------- */
function log(t){
  logBox.textContent = new Date().toLocaleTimeString() + "  " + t + "\n" + logBox.textContent;
}

/* ----------------------------
   5. 监听数据库变化（实时同步给所有人）
----------------------------- */
async function subscribeRealtime(){
    const query = new AV.Query("NameList");
    query.equalTo("room", ROOM_ID);

    const liveQuery = await query.subscribe();
    liveQuery.on("create", refreshListFromCloud);
    liveQuery.on("update", refreshListFromCloud);
    liveQuery.on("delete", refreshListFromCloud);

    log("已开启实时同步");
}
subscribeRealtime();

/* ----------------------------
   6. 从云端读取名单并刷新 UI
----------------------------- */
async function refreshListFromCloud(){
    const query = new AV.Query("NameList");
    query.equalTo("room", ROOM_ID);
    query.limit(500);

    const results = await query.find();

    const arr = results.map(r => r.get("name"));
    namesInput.value = arr.join("\n");

    log("云端名单已更新，共 " + arr.length + " 人");
}

/* 首次加载时也拉一次 */
refreshListFromCloud();

/* ----------------------------
   7. 用户输入名单 → 自动写入云端
----------------------------- */
namesInput.addEventListener("change", async ()=>{
    // 普通用户也要写入云端，但是只能添加自己的名字
    const newList = namesInput.value.split(/\n|,|;/).map(s => s.trim()).filter(Boolean);

    // 清空表（只有房主可以）
    if(isOwner){
        const q = new AV.Query("NameList");
        q.equalTo("room", ROOM_ID);
        const results = await q.find();
        await AV.Object.destroyAll(results);
    }

    // 全部重新写入（房主）
    // 普通用户：只增加新名字
    for(const nm of newList){
        const obj = new NameList();
        obj.set("room", ROOM_ID);
        obj.set("name", nm);
        await obj.save();
    }

    log("已写入云端");
});

/* ----------------------------
   8. 房主可清空列表
----------------------------- */
clearNamesBtn.addEventListener("click", async ()=>{
    if(!isOwner) return alert("你不是房主，不能清空");

    if(!confirm("确定要清空名单吗？")) return;

    const q = new AV.Query("NameList");
    q.equalTo("room", ROOM_ID);
    const results = await q.find();
    await AV.Object.destroyAll(results);

    namesInput.value = "";
    log("已清空云端名单");
});

/* ----------------------------
   9. 以下是你原有的抽签逻辑，不动 UI
----------------------------- */
let lastWinners = [];

function shuffle(array){
    let a = array.slice();
    for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random() * (i+1));
        [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
}

function displaySlots(n){
    slots.innerHTML = "";
    for(let i=0;i<n;i++){
        const div = document.createElement("div");
        div.className = "animated-slot";
        div.textContent = "— 抽签槽 " + (i+1);
        slots.appendChild(div);
    }
}

function animateReveal(names, duration=1200){
    const slotEls = Array.from(slots.children);
    const pool = namesInput.value.split("\n").filter(Boolean);
    winnersDiv.innerHTML="";
    lastWinners = [];

    slotEls.forEach((el, idx)=>{
        let r = 0;
        let rounds = 18;
        const interval = Math.max(20, duration/rounds);

        const timer = setInterval(()=>{
            el.textContent = pool[Math.floor(Math.random()*pool.length)] || "—";
            r++;
            if(r >= rounds){
                clearInterval(timer);
                el.textContent = names[idx] || "—";
                const pill = document.createElement("span");
                pill.className = "winner-pill";
                pill.textContent = (idx+1) + ". " + (names[idx] || "—");
                winnersDiv.appendChild(pill);
                lastWinners.push(names[idx]||"");
            }
        }, interval);
    });
}

/* 房主点击抽签 */
drawBtn.addEventListener("click", ()=>{
    if(!isOwner){
        return alert("你不是房主，不能抽签");
    }

    const pool = namesInput.value.split("\n").filter(Boolean);
    if(pool.length === 0){
        alert("名单为空");
        return;
    }

    const n = parseInt(document.getElementById("count").value) || 1;
    displaySlots(n);

    const pick = shuffle(pool).slice(0,n);
    animateReveal(pick, 1200);

    log("已抽取 " + n + " 人");
});
</script>
</body>
</html>

